# TopUp Manual Flow - Database-First Implementation

## Overview
Alur topup sudah diperbaiki untuk mengikuti konsep **database-first**:
1. User pilih bank â†’ Klik tombol "Saya Sudah Transfer"
2. API `topUpSaldo()` create transaction di database
3. Server return `nomorTransaksi` yang auto-generated
4. Navigate ke `TopupKonfirmasi` dengan data dari database
5. Upload foto bukti transfer ke `foto-bukti-transfer` endpoint
6. Validasi response sebelum show success message

## Detailed Flow

### Step 1: Bank Selection
**File**: `lib/ui/home/topup/topup_manual.dart`

**Implementation**:
- State variable: `BankAccount? _selectedBank`
- Display list of banks in ListView
- Each bank card is wrapped with `GestureDetector`
- On tap: `setState(() { _selectedBank = selectedBank; })`

**Code**:
```dart
_BankDetailCard(
  bank: bank,
  primaryColor: widget.primaryColor,
  onSelected: (selectedBank) {
    setState(() {
      _selectedBank = selectedBank;
    });
    print('âœ… [TOPUP] Bank selected: ${selectedBank.namaBank}');
  },
);
```

### Step 2: Klik "Saya Sudah Transfer" Button
**File**: `lib/ui/home/topup/topup_manual.dart` (lines 490-575)

**Process Flow**:
```
1. Validate bank is selected
   if (_selectedBank == null) â†’ show error snackbar
   
2. Get user token from SessionManager
   final userToken = await SessionManager.getToken();
   
3. Call topUpSaldo() API
   final topupResponse = await widget.apiService.topUpSaldo(
     amount: _totalAmount.toString(),
     bankName: _selectedBank!.namaBank ?? '',
     nomorRekening: _selectedBank!.nomorRekening ?? '',
     namaRekening: _selectedBank!.atasNamaRekening ?? '',
     userToken: userToken,
     adminUserId: AppConfig().adminId,
   );
   
4. Validate API response
   if (topupResponse.status != true) â†’ throw exception
   
5. Extract nomorTransaksi from response
   final nomorTransaksi = topupResponse.data?.nomorTransaksi;
   
6. Navigate to TopupKonfirmasi
   Navigator.push(MaterialPageRoute(
     builder: (context) => TopupKonfirmasi(
       nomorTransaksi: nomorTransaksi,
       totalAmount: _totalAmount,
       primaryColor: widget.primaryColor,
       apiService: widget.apiService,
     ),
   ));
```

**Key Points**:
- Transaction number is **server-generated**, not client-side
- Bank information used: `namaBank`, `nomorRekening`, `atasNamaRekening`
- All API calls use Bearer token from SessionManager
- Error messages are user-friendly

### Step 3: TopupKonfirmasi Page
**File**: `lib/ui/home/topup/topup_konfirmasi.dart`

**Display Transaction Info**:
- Badge showing "âœ“ Nomor transaksi dari database"
- Transaction number (server-generated)
- Total transfer amount

**User Actions**:
1. Tap "Ambil Foto" (camera) or "Pilih dari Galeri" (gallery)
2. Image picker opens
3. Image preview displays immediately after selection
4. Tap "Unggah Bukti Transfer" to upload

### Step 4: Upload Payment Proof
**File**: `lib/core/network/api_service.dart` â†’ `uploadPaymentProof()` (lines 1004-1086)

**Process**:
```
1. Validate image selected
   if (_selectedImageBytes == null) â†’ show error snackbar
   
2. Get user token
   final token = await SessionManager.getToken();
   
3. Call uploadPaymentProof() API
   final response = await widget.apiService.uploadPaymentProof(
     nomorTransaksi: widget.nomorTransaksi,
     photoPath: _selectedImageFile?.path,
     photoBytes: _selectedImageBytes,
     photoFileName: _selectedImageFileName,
     userToken: token,
   );
   
4. Validate response
   - Check statusCode == 200
   - Check response.data['status'] field
   - Status must be: true || 'true' || 1
   
5. Show success or error
   if (isSuccess) â†’ show success dialog
   else â†’ throw exception and show error
   
6. Navigate back on success
   Navigator.of(context).pop();  // Close dialog
   Navigator.of(context).pop();  // Go back to topup_manual
   Navigator.of(context).pop();  // Go back to home
```

## API Endpoints

### 1. POST /api/topup
**Create topup transaction in database**

**Request Headers**:
```
Authorization: Bearer {userToken}
X-Admin-Token: {adminToken}
Content-Type: application/x-www-form-urlencoded
```

**Request Body**:
```json
{
  "amount": "100000",
  "bank_name": "BCA",
  "nomor_rekening": "1234567890",
  "nama_rekening": "John Doe",
  "nomor_transaksi": "auto-generated by server",
  "batas_waktu": "2026-01-26T10:00:00Z"
}
```

**Response**:
```json
{
  "status": true,
  "message": "Topup created successfully",
  "data": {
    "id": 123,
    "user_id": 456,
    "amount": "100000",
    "bank_name": "BCA",
    "nomor_rekening": "1234567890",
    "nama_rekening": "John Doe",
    "nomor_transaksi": "1050_Trxtopup_123456",
    "batas_waktu": "2026-01-26T10:00:00Z",
    "status": "pending",
    "created_at": "2026-01-23T10:00:00Z",
    "updated_at": "2026-01-23T10:00:00Z"
  }
}
```

### 2. POST /api/foto-bukti-transfer
**Upload payment proof image**

**Request Headers**:
```
Authorization: Bearer {userToken}
Content-Type: multipart/form-data
```

**Request Body**:
```
Field: nomor_transaksi = "1050_Trxtopup_123456"
File:  photo = {image_file}
```

**Response**:
```json
{
  "status": true,
  "message": "Bukti transfer berhasil diunggah ke database"
}
```

## Transaction Number Generation

**Generated by**: Backend API (api/topup)
**Format**: `{adminId}_Trxtopup_{6-digit-random}`
**Example**: `1050_Trxtopup_123456`

**Generation Logic**:
```php
// Backend logic
$random = str_pad(random_int(0, 999999), 6, '0', STR_PAD_LEFT);
$nomorTransaksi = "{$adminId}_Trxtopup_{$random}";
```

## State Management

### TopupManualState Variables:
```dart
late int _uniqueCode;           // 3-digit random code
late int _totalAmount;          // Total topup amount
int? _adminFee;                 // Admin fee from API
bool _isLoading;                // Loading state
List<BankAccount> _bankAccounts; // List of available banks
BankAccount? _selectedBank;     // Currently selected bank
```

### TopupKonfirmasiState Variables:
```dart
File? _selectedImageFile;        // For mobile file path
List<int>? _selectedImageBytes;  // Universal image storage
String? _selectedImageFileName;  // Filename for both platforms
bool _isUploading;               // Upload progress state
```

## Error Handling

### Validation Errors:
1. **Bank not selected**
   - Message: "Pilih bank terlebih dahulu"
   - Shown: Snackbar

2. **Image not selected**
   - Message: "Silakan pilih foto bukti terlebih dahulu"
   - Shown: Snackbar

3. **Token not found**
   - Message: "Token tidak ditemukan. Silakan login kembali."
   - Shown: Snackbar

### API Errors:
1. **TopUp creation failed**
   - Message: API response message or "Gagal membuat topup: {error}"
   - Shown: Snackbar

2. **Photo upload failed**
   - Message: "Upload failed: Server returned error or invalid response"
   - Shown: Snackbar

## Logging

### TopUp Manual Logs:
```
ğŸ” [TOPUP] Saya Sudah Transfer button pressed
ğŸ” [TOPUP] Total Amount: 100000
ğŸ” [TOPUP] Selected Bank: BCA
ğŸ” [TOPUP] User Token: xx...
âœ… [TOPUP] Bank selected: BCA
ğŸ” [TOPUP] Calling topUpSaldo API...
ğŸ” [TOPUP] API Response: true
ğŸ” [TOPUP] Message: Success
âœ… [TOPUP] Transaction created successfully!
âœ… [TOPUP] No. Transaksi: 1050_Trxtopup_123456
âœ… [TOPUP] Navigating to confirmation page...
```

### TopUp Konfirmasi Logs:
```
ğŸ” [CONFIRM] Opening camera to capture proof...
âœ… [CONFIRM] Image captured: /path/to/image.jpg
ğŸ” [CONFIRM] Starting upload process...
ğŸ” [CONFIRM] No. Transaksi: 1050_Trxtopup_123456
ğŸ” [CONFIRM] Image size: 245678 bytes
âœ… [CONFIRM] Upload response status: 200
âœ… [CONFIRM] Response status field: true
âœ… [CONFIRM] Is success: true
```

### API Service Logs:
```
ğŸ” [API] ===== TOP UP SALDO START =====
ğŸ” [API] Endpoint: api/topup
ğŸ” [API] Amount: 100000
ğŸ” [API] Bank Name: BCA
ğŸ” [API] Admin Token: xxxx...
ğŸ” [API] Batas Waktu: 2026-01-26T10:00:00Z
âœ… [API] Status Code: 200
âœ… [API] ===== TOP UP SALDO END =====

ğŸ” [API] ===== UPLOAD PAYMENT PROOF START =====
ğŸ” [API] Platform: MOBILE
ğŸ” [API] Photo Path: /path/to/file
ğŸ” [API] FormData fields: 1
ğŸ” [API] FormData files: 1
âœ… [API] Status Code: 200
âœ… [API] ===== UPLOAD PAYMENT PROOF END =====
```

## Testing Checklist

- [ ] Click "Saya Sudah Transfer" without selecting bank â†’ Error message
- [ ] Select a bank â†’ State updates
- [ ] Click "Saya Sudah Transfer" with bank selected
- [ ] API call succeeds and returns transaction number
- [ ] Navigate to TopupKonfirmasi with correct parameters
- [ ] Transaction info displays with database badge
- [ ] Can take photo from camera
- [ ] Can select photo from gallery
- [ ] Photo displays in preview immediately
- [ ] Can upload photo with valid image
- [ ] Upload succeeds and shows success dialog
- [ ] Success dialog shows "Bukti transfer berhasil diunggah ke database"
- [ ] Can navigate back to home after completion
- [ ] All logs appear in console for debugging

## Key Changes Made

1. âœ… **Bank selection state management**
   - Added `BankAccount? _selectedBank` state variable
   - Wrapped _BankDetailCard with GestureDetector for click handling
   - Added `onSelected` callback to update state

2. âœ… **Transaction creation flow**
   - Moved from client-side generation to server-side
   - API call to `topUpSaldo()` creates transaction in database
   - Extract `nomorTransaksi` from response

3. âœ… **Navigation with server data**
   - Pass server-generated `nomorTransaksi` to TopupKonfirmasi
   - Display badge showing "dari database"

4. âœ… **Photo upload with validation**
   - Validate response status code (200)
   - Validate response status field
   - Only show success if database confirms

5. âœ… **Error handling improvements**
   - Bank selection validation
   - Image selection validation
   - User-friendly error messages
   - Comprehensive logging for debugging

## Production Readiness

This implementation is **production-ready** with:
- âœ… Proper error handling
- âœ… Comprehensive logging
- âœ… User-friendly messages
- âœ… Database integrity validation
- âœ… Cross-platform support (web & mobile)
- âœ… State management best practices
- âœ… Navigation flow validation

